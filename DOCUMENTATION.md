# OlimpQR - Техническая документация

## Содержание

1. [Обзор системы](#1-обзор-системы)
2. [Стек технологий](#2-стек-технологий)
3. [Архитектура](#3-архитектура)
4. [Инфраструктура (Docker)](#4-инфраструктура-docker)
5. [База данных](#5-база-данных)
6. [Безопасность и шифрование](#6-безопасность-и-шифрование)
7. [Система QR-кодов и токенов](#7-система-qr-кодов-и-токенов)
8. [Генерация бланков ответов (PDF)](#8-генерация-бланков-ответов-pdf)
9. [Конвейер OCR-распознавания](#9-конвейер-ocr-распознавания)
10. [Порядок работы системы](#10-порядок-работы-системы)
11. [API-эндпоинты](#11-api-эндпоинты)
12. [Фронтенд](#12-фронтенд)
13. [Тестирование](#13-тестирование)

---

## 1. Обзор системы

**OlimpQR** - система управления олимпиадными соревнованиями с анонимным отслеживанием бланков ответов через QR-коды. Система охватывает полный цикл: от регистрации участников до публикации результатов.

Ключевые принципы:
- **Анонимность проверки** - проверяющий не знает, чей бланк он проверяет. Связь между участником и бланком осуществляется только через зашифрованный QR-код.
- **Автоматизация** - OCR-распознавание баллов с автоматическим применением при высокой уверенности.
- **Аудит** - все критические действия логируются с IP-адресом и временной меткой.

---

## 2. Стек технологий

### Бэкенд
| Технология | Версия | Назначение |
|---|---|---|
| **Python** | 3.13 | Основной язык |
| **FastAPI** | 0.115+ | REST API фреймворк |
| **SQLAlchemy** | 2.0 (async) | ORM с асинхронным драйвером |
| **asyncpg** | 0.30+ | Асинхронный драйвер PostgreSQL |
| **Alembic** | 1.13+ | Миграции базы данных |
| **Celery** | 5.4+ | Асинхронная очередь задач |
| **PaddleOCR** | 2.8+ | Распознавание текста |
| **OpenCV** | 4.10+ | Обработка изображений |
| **PyMuPDF** | 1.24+ | Конвертация PDF в изображения |
| **ReportLab** | 4.2+ | Генерация PDF-бланков |
| **bcrypt** | 4.0+ | Хэширование паролей |
| **PyJWT** | 2.9+ | JWT-токены аутентификации |
| **MinIO SDK** | 7.2+ | Клиент S3-хранилища |
| **pyzbar** | 0.1.9+ | Декодирование QR-кодов |
| **slowapi** | 0.1.9+ | Rate-limiting |
| **Pydantic** | 2.10+ | Валидация данных |

### Фронтенд
| Технология | Назначение |
|---|---|
| **React** | UI-фреймворк |
| **TypeScript** | Типизация |
| **Vite** | Сборщик и dev-сервер |
| **Zustand** | Управление состоянием |
| **React Router 6** | Маршрутизация |
| **Axios** | HTTP-клиент с JWT-интерсептором |

### Инфраструктура
| Сервис | Назначение |
|---|---|
| **PostgreSQL 16** | Основная база данных |
| **Redis 7** | Брокер Celery + хранение rate-limit |
| **MinIO** | S3-совместимое хранилище файлов |
| **Docker Compose** | Оркестрация контейнеров |

---

## 3. Архитектура

### Чистая архитектура (Clean Architecture)

Система построена по принципу чистой архитектуры с 4 слоями. Зависимости направлены строго внутрь: `presentation → application → domain`, а `infrastructure` реализует интерфейсы из `domain` и `application`.

```
┌─────────────────────────────────────────────────────────┐
│                    PRESENTATION                          │
│            (FastAPI роутеры, Pydantic схемы)             │
│                                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                   APPLICATION                        │ │
│  │          (Use Cases, DTO, интерфейсы)                │ │
│  │                                                      │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │                    DOMAIN                        │ │ │
│  │  │    (Сущности, Value Objects, Сервисы,            │ │ │
│  │  │     Абстрактные репозитории)                     │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                   INFRASTRUCTURE                         │
│   (SQLAlchemy, MinIO, PaddleOCR, bcrypt, JWT, Celery)   │
│   Реализует интерфейсы из Domain и Application          │
└─────────────────────────────────────────────────────────┘
```

### Структура каталогов бэкенда

```
backend/src/olimpqr/
├── domain/                     # Чистая бизнес-логика
│   ├── entities/               # Сущности (User, Competition, Attempt и др.)
│   ├── value_objects/          # UserRole, CompetitionStatus, Token и др.
│   ├── services/               # TokenService (HMAC), QRService
│   └── repositories/           # Абстрактные интерфейсы репозиториев
│
├── application/                # Слой Use Cases
│   ├── use_cases/              # Классы с единственным методом execute()
│   ├── dto/                    # Объекты передачи данных между слоями
│   └── interfaces/             # Абстрактные интерфейсы сервисов (OCR, PDF, Storage)
│
├── infrastructure/             # Технические реализации
│   ├── database/               # SQLAlchemy 2.0 async модели, сессии, Alembic
│   ├── repositories/           # Реализации репозиториев (SQLAlchemy)
│   ├── security/               # bcrypt пароли, PyJWT токены, rate limiting
│   ├── ocr/                    # PaddleOCR + OpenCV пайплайн
│   ├── pdf/                    # ReportLab генерация бланков
│   ├── storage/                # MinIO S3 клиент
│   └── tasks/                  # Celery задачи (OCR-обработка)
│
└── presentation/               # API-слой FastAPI
    ├── api/v1/                 # Роутеры (auth, competitions, admission, scans и др.)
    ├── dependencies/           # JWT-аутентификация + RBAC (require_role)
    └── schemas/                # Pydantic v2 схемы запросов/ответов
```

### Схема взаимодействия компонентов

```
                    ┌──────────┐
                    │  Браузер │
                    └────┬─────┘
                         │ HTTP/HTTPS
                    ┌────▼─────┐
                    │ Frontend │ (React + Vite, порт 5173)
                    │  Nginx   │ проксирует /api → backend
                    └────┬─────┘
                         │
                    ┌────▼─────┐
                    │ Backend  │ (FastAPI, порт 8000)
                    │  API     │
                    └┬───┬───┬─┘
                     │   │   │
          ┌──────────┘   │   └──────────┐
          │              │              │
     ┌────▼────┐   ┌────▼────┐   ┌────▼────┐
     │PostgreSQL│   │  Redis  │   │  MinIO  │
     │  (БД)   │   │ (Брокер)│   │(Файлы)  │
     └─────────┘   └────┬────┘   └────▲────┘
                        │              │
                   ┌────▼────┐         │
                   │ Celery  │─────────┘
                   │ Worker  │ (OCR-обработка)
                   └─────────┘
```

---

## 4. Инфраструктура (Docker)

Система разворачивается через `docker-compose.yml` и включает 6 контейнеров:

| Контейнер | Образ | Порт | Назначение |
|---|---|---|---|
| `olimpqr-postgres` | postgres:16-alpine | 5432 | База данных |
| `olimpqr-redis` | redis:7-alpine | 6379 | Брокер задач |
| `olimpqr-minio` | minio/minio | 9000, 9001 | Хранилище файлов |
| `olimpqr-backend` | python:3.13-slim | 8000 | API-сервер |
| `olimpqr-celery` | python:3.13-slim | — | OCR-воркер |
| `olimpqr-frontend` | node:20-alpine | 5173 | Web-интерфейс |

### Хранилище MinIO

MinIO предоставляет S3-совместимое хранилище с двумя бакетами:

| Бакет | Содержимое | Формат имён объектов |
|---|---|---|
| `answer-sheets` | Сгенерированные PDF-бланки | `sheets/{attempt_id}.pdf` |
| `scans` | Загруженные сканы | `scans/{scan_id}.{ext}` |

---

## 5. База данных

### Схема таблиц (PostgreSQL 16)

```
┌──────────────┐     ┌────────────────┐     ┌────────────────┐
│    users     │     │  participants  │     │  competitions  │
├──────────────┤     ├────────────────┤     ├────────────────┤
│ id (PK, UUID)│◄────│ user_id (FK)   │     │ id (PK, UUID)  │
│ email        │     │ id (PK, UUID)  │     │ name           │
│ password_hash│     │ full_name      │     │ date           │
│ role (enum)  │     │ school         │     │ reg_start      │
│ is_active    │     │ grade          │     │ reg_end        │
│ created_at   │     │ created_at     │     │ variants_count │
│ updated_at   │     │ updated_at     │     │ max_score      │
└──────────────┘     └────────────────┘     │ status (enum)  │
       │                    │               │ created_by (FK)│
       │                    │               │ created_at     │
       │                    │               └───────┬────────┘
       │                    │                       │
       │              ┌─────▼───────────────────────▼──────┐
       │              │          registrations              │
       │              ├────────────────────────────────────┤
       │              │ id (PK, UUID)                       │
       │              │ participant_id (FK → participants)  │
       │              │ competition_id (FK → competitions)  │
       │              │ status (enum)                       │
       │              │ created_at, updated_at              │
       │              └───────┬──────────┬─────────────────┘
       │                      │          │
       │              ┌───────▼───┐  ┌───▼───────────┐
       │              │entry_tokens│  │   attempts    │
       │              ├───────────┤  ├───────────────┤
       │              │ id (UUID) │  │ id (UUID)     │
       │              │ token_hash│  │ reg_id (FK)   │
       │              │ reg_id(FK)│  │ variant_number│
       │              │ expires_at│  │ sheet_token_  │
       │              │ used_at   │  │   hash        │
       │              └───────────┘  │ status (enum) │
       │                             │ score_total   │
       │                             │ confidence    │
       │                             │ pdf_file_path │
       │                             └───────┬───────┘
       │                                     │
       │                             ┌───────▼───────┐
       │                             │     scans     │
       │                             ├───────────────┤
       │                             │ id (UUID)     │
       │                             │ attempt_id(FK)│
       │                             │ file_path     │
       │                             │ ocr_score     │
       │                             │ ocr_confidence│
       │                             │ ocr_raw_text  │
       │                             │ verified_by   │
       │                             │ uploaded_by   │
       │                             └───────────────┘
       │
       │              ┌───────────────┐
       └──────────────► audit_logs    │
                      ├───────────────┤
                      │ id (UUID)     │
                      │ entity_type   │
                      │ entity_id     │
                      │ action        │
                      │ user_id (FK)  │
                      │ ip_address    │
                      │ details (JSON)│
                      │ timestamp     │
                      └───────────────┘
```

### Перечисления (PostgreSQL Enums)

**UserRole** - роли пользователей:
| Значение | Описание |
|---|---|
| `participant` | Участник олимпиады |
| `admitter` | Допуск (проверка QR на входе) |
| `scanner` | Сканирование бланков |
| `admin` | Полный доступ |

**CompetitionStatus** - статусы олимпиады:
| Значение | Описание |
|---|---|
| `draft` | Черновик (только создана) |
| `registration_open` | Открыта регистрация |
| `in_progress` | Идёт проведение |
| `checking` | Проверка работ |
| `published` | Результаты опубликованы |

**RegistrationStatus** - статусы регистрации:
| Значение | Описание |
|---|---|
| `pending` | Ожидание допуска |
| `admitted` | Допущен (QR проверен) |
| `completed` | Бланк выдан |
| `cancelled` | Отменено |

**AttemptStatus** - статусы бланка ответа:
| Значение | Описание |
|---|---|
| `printed` | Бланк напечатан и выдан |
| `scanned` | Скан загружен, требует проверки |
| `scored` | Балл выставлен |
| `published` | Результат опубликован |
| `invalidated` | Аннулировано |

---

## 6. Безопасность и шифрование

### 6.1 Хэширование паролей (bcrypt)

Пароли никогда не хранятся в открытом виде. Используется алгоритм **bcrypt** с автоматически генерируемой солью.

```
Регистрация:
  пароль → bcrypt.hashpw(пароль, bcrypt.gensalt()) → хэш → БД

Вход:
  пароль + хэш из БД → bcrypt.checkpw(пароль, хэш) → True/False
```

Особенность: используется прямой вызов библиотеки `bcrypt`, а не `passlib`, из-за несовместимости passlib с bcrypt >= 4.1.

### 6.2 JWT-аутентификация (HS256)

Все API-запросы (кроме публичных) требуют JWT-токен в заголовке `Authorization: Bearer <token>`.

```
Генерация токена:
  ┌────────────────────────────────┐
  │         JWT Payload            │
  ├────────────────────────────────┤
  │ sub: UUID пользователя         │
  │ email: email пользователя      │
  │ role: роль (participant и др.) │
  │ iat: время выдачи (UTC)        │
  │ exp: время истечения (UTC)     │
  └────────────────────────────────┘
           │
           ▼  HMAC-SHA256(payload, SECRET_KEY)
  ┌────────────────────────────────┐
  │       JWT Token (строка)       │
  │  header.payload.signature      │
  └────────────────────────────────┘

Проверка токена:
  токен → декодирование → проверка подписи → проверка exp → JWTPayload
```

- **Алгоритм:** HS256 (HMAC-SHA256)
- **Время жизни:** 24 часа (настраивается через `jwt_expire_minutes`)
- **Секретный ключ:** минимум 32 символа (`SECRET_KEY`)

### 6.3 RBAC (Ролевой доступ)

Каждый эндпоинт защищён фабрикой `require_role()`:

```python
# Пример: эндпоинт доступен только сканировщикам и администраторам
@router.post("/upload")
async def upload_scan(
    current_user: User = Depends(require_role(UserRole.SCANNER, UserRole.ADMIN))
):
    ...
```

Матрица доступа:

| Действие | Participant | Admitter | Scanner | Admin |
|---|:---:|:---:|:---:|:---:|
| Регистрация на олимпиаду | + | - | - | - |
| Просмотр QR-кода допуска | + | - | - | - |
| Проверка QR на входе | - | + | - | + |
| Выдача бланков | - | + | - | + |
| Загрузка сканов | - | - | + | + |
| Верификация баллов | - | - | + | + |
| Управление олимпиадами | - | - | - | + |
| Управление пользователями | - | - | - | + |
| Просмотр аудит-лога | - | - | - | + |

### 6.4 Rate-limiting

| Эндпоинт | Лимит |
|---|---|
| `POST /auth/register` | 3 запроса в минуту |
| `POST /auth/login` | 5 запросов в минуту |

Реализовано через библиотеку **slowapi** (ASGI middleware). Автоматически отключается при `ENVIRONMENT=test`.

---

## 7. Система QR-кодов и токенов

Система использует два типа QR-кодов, каждый с криптографической защитой через **HMAC-SHA256**.

### 7.1 Генерация токенов

```
┌─────────────────────────────────────────────────────┐
│               TokenService.generate_token()          │
├─────────────────────────────────────────────────────┤
│                                                      │
│  1. raw_token = secrets.token_urlsafe(32)           │
│     └─ 256 бит криптографически стойкой энтропии     │
│                                                      │
│  2. token_hash = HMAC-SHA256(HMAC_SECRET_KEY, raw)  │
│     └─ 64-символьный hex-дайджест                    │
│                                                      │
│  3. Возврат: Token(raw=raw_token, hash=token_hash)  │
│                                                      │
│  В БД хранится ТОЛЬКО хэш, raw токен — в QR-коде   │
└─────────────────────────────────────────────────────┘
```

### 7.2 Верификация токенов

```
QR-код (raw_token) → HMAC-SHA256(secret, raw) → сравнение с хэшем в БД
                                                  │
                                        hmac.compare_digest()
                                     (защита от timing-атак)
```

### 7.3 Типы QR-кодов

#### QR-код допуска (Entry Token)

| Параметр | Значение |
|---|---|
| Назначение | Идентификация участника при входе |
| Время жизни | 24 часа |
| Одноразовый | Да (поле `used_at`) |
| Можно обновить | Да (refresh) |
| Уровень коррекции | H (30% ошибок) |

```
Участник                 Допускающий (Admitter)
    │                          │
    │  Показывает QR ──────►  │
    │                          │  Сканирует QR
    │                          │  Вычисляет HMAC-SHA256
    │                          │  Ищет entry_token по хэшу
    │                          │  Проверяет: не истёк? не использован?
    │  ◄── Допуск одобрен ──  │
    │                          │  Отмечает used_at = now()
```

#### QR-код бланка ответа (Sheet Token)

| Параметр | Значение |
|---|---|
| Назначение | Связь скана с попыткой (анонимно) |
| Время жизни | До конца олимпиады |
| Многоразовый | Да (можно сканировать повторно) |
| Встроен в | PDF-бланк ответа |

```
Бланк ответа                    Celery Worker
    │                                │
    │  Скан загружен ──────────►    │
    │                                │  Декодирует QR из изображения
    │                                │  Извлекает raw sheet_token
    │                                │  Вычисляет HMAC-SHA256
    │                                │  Ищет attempt по sheet_token_hash
    │  ◄── Скан привязан ────────   │  Связывает scan ↔ attempt
```

---

## 8. Генерация бланков ответов (PDF)

Бланки генерируются библиотекой **ReportLab** на стороне сервера.

### Макет бланка (A4, 210×297 мм)

```
┌─────────────────────────────────────────────┐
│  [Логотип]              [QR-код бланка]     │  ← Верхняя часть
│                                              │
│             БЛАНК ОТВЕТОВ                    │  ← Заголовок (18pt, жирный)
│                                              │
│  ВНИМАНИЕ! Заполняйте строго внутри рамки   │  ← Предупреждение (красный)
│                                              │
│  ┌──────────────────────────────────────┐    │
│  │ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊  │    │
│  │─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊──│    │  ← Сетка для ответов
│  │ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊  │    │     (клетки 10×10 мм)
│  │─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊─┊──│    │
│  │ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊ ┊  │    │
│  └──────────────────────────────────────┘    │
│                                              │
│                    ИТОГОВЫЙ БАЛЛ: [___]       │  ← Поле для балла
│        Напишите балл ПЕЧАТНЫМИ цифрами       │     (фиксированная позиция
│                                              │      для OCR)
│  Инструкции:                                 │
│  1. Отвечайте чётко и разборчиво             │  ← Подвал
│  2. Укажите итоговый балл                    │
│  3. Не сгибайте и не пачкайте лист           │
└─────────────────────────────────────────────┘
```

**Шрифты:** Liberation Serif (формальный, аналог Times New Roman) с поддержкой кириллицы. Запасной — DejaVu Sans.

**QR-код бланка:**
- Размер: 40×40 мм
- Уровень коррекции ошибок: H (выдерживает до 30% повреждений)
- Содержит: `raw sheet_token` (256-битный случайный токен)

**Поле итогового балла:**
- Фиксированная позиция (настраивается в config.py)
- Толстая чёрная рамка (2pt) для распознавания OCR
- Координаты передаются в OCR-пайплайн для точного кропа

---

## 9. Конвейер OCR-распознавания

### Общая схема

```
┌────────────┐     ┌──────────┐     ┌──────────────┐
│  Загрузка  │     │  MinIO   │     │   Celery     │
│  скана     │────►│ хранилище│────►│   Worker     │
│ (Scanner)  │     │          │     │              │
└────────────┘     └──────────┘     └──────┬───────┘
                                           │
                              ┌────────────▼────────────┐
                              │                          │
                         ┌────▼─────┐            ┌──────▼──────┐
                         │ QR-код   │            │ OCR балла   │
                         │ pyzbar   │            │ PaddleOCR   │
                         └────┬─────┘            └──────┬──────┘
                              │                         │
                         ┌────▼─────┐            ┌──────▼──────┐
                         │ HMAC →   │            │ Уверенность │
                         │ Attempt  │            │   ≥ 0.7?    │
                         └────┬─────┘            └──┬───────┬──┘
                              │                    Да       Нет
                              │                    │         │
                         ┌────▼────────────────────▼──┐  ┌──▼──────────┐
                         │ Автоприменение балла       │  │ Ручная      │
                         │ attempt.status = SCORED    │  │ верификация │
                         └────────────────────────────┘  └─────────────┘
```

### Этапы обработки изображения

```
1. Декодирование
   ├─ cv2.imdecode() для PNG/JPEG
   └─ PyMuPDF (fitz) для PDF → PNG (300 DPI)

2. Извлечение QR-кода (pyzbar)
   ├─ Поиск всех QR-кодов в изображении
   ├─ Декодирование raw sheet_token
   ├─ HMAC-SHA256(secret, raw) → хэш
   └─ Поиск attempt по sheet_token_hash

3. Кроп области балла
   ├─ Перевод координат: мм → пиксели (300 DPI / 25.4 ≈ 11.81 px/мм)
   ├─ Добавление запаса ±10%
   └─ Вырезание области из полного изображения

4. Предобработка (OpenCV)
   ├─ Перевод в оттенки серого
   ├─ CLAHE (адаптивная нормализация контраста)
   │   └─ clipLimit=2.0, tileGridSize=(8,8)
   └─ Бинаризация Оцу (Otsu thresholding)

5. Распознавание текста (PaddleOCR)
   ├─ Модель: англоязычная (цифры)
   ├─ Детекция углов текста (angle_cls=True)
   └─ Результат: текст + confidence

6. Извлечение числа
   └─ Первое целое число из распознанного текста (regex)

7. Принятие решения
   ├─ confidence ≥ 0.7 → автоприменение балла
   └─ confidence < 0.7 → требует ручной проверки
```

### Celery-задача `process_scan_ocr`

- **Максимум повторов:** 3
- **Задержка между повторами:** 30 секунд
- **Выполнение:** синхронное (Celery работает в sync-режиме)
- **Драйвер БД:** psycopg2 (синхронный, в отличие от asyncpg в API)

---

## 10. Порядок работы системы

### Полный цикл проведения олимпиады

```
 ① Создание         ② Открытие          ③ Регистрация       ④ Старт
 олимпиады          регистрации          участников          олимпиады
 (Admin)            (Admin)              (Participant)       (Admin)
    │                   │                    │                   │
    ▼                   ▼                    ▼                   ▼
 DRAFT ──────► REGISTRATION_OPEN ─────────────────────► IN_PROGRESS
                        │                                    │
                        │  Участник получает                 │
                        │  QR-код допуска                    │
                        │  (Entry Token)                     │
                        │                                    │
                        ▼                                    ▼
                 ⑤ Допуск (Admitter)              ⑥ Выполнение работы
                 Сканирование QR допуска           Участник заполняет
                 Проверка токена                   бланк ответов
                 Выдача бланка PDF                 Пишет итоговый балл
                        │
                        ▼
                 ⑦ Сканирование (Scanner)
                 Загрузка скана в систему
                 Celery: QR → Attempt
                 Celery: OCR → Балл
                        │
                 ┌──────┴──────┐
                 ▼             ▼
          Авто (≥70%)    Ручная проверка
          SCORED         SCANNED → verify → SCORED
                 │             │
                 └──────┬──────┘
                        ▼
                 ⑧ Проверка (Admin)
                 CHECKING
                        │
                        ▼
                 ⑨ Публикация (Admin)
                 PUBLISHED
                        │
                        ▼
                 ⑩ Просмотр результатов
                 (Participant / Public)
```

### Детальное описание каждого этапа

#### Этап 1: Создание олимпиады (Администратор)

Администратор создаёт олимпиаду, указывая название, дату, период регистрации, количество вариантов и максимальный балл. Олимпиада создаётся в статусе `DRAFT`.

#### Этап 2: Открытие регистрации (Администратор)

Администратор переводит олимпиаду в статус `REGISTRATION_OPEN`. Участники могут начать регистрироваться.

#### Этап 3: Регистрация участника

1. Участник создаёт аккаунт (email, пароль, ФИО, школа, класс)
2. Входит в систему и получает JWT-токен
3. Регистрируется на олимпиаду
4. Система генерирует **Entry Token** (QR-код допуска):
   - 256-битный случайный токен → HMAC-SHA256 → хэш в БД
   - QR-код с raw-токеном показывается участнику
   - Время жизни: 24 часа (можно обновить)

#### Этап 4: Старт олимпиады (Администратор)

Олимпиада переходит в статус `IN_PROGRESS`. Начинается допуск участников.

#### Этап 5: Допуск участника (Допускающий / Admitter)

1. Участник показывает QR-код на экране телефона
2. Допускающий сканирует QR → извлекает `raw entry_token`
3. Система: `HMAC-SHA256(secret, raw)` → поиск по хэшу в БД
4. Проверки: не истёк ли? Не использован ли?
5. При успехе:
   - Entry token помечается как использованный
   - Генерируется **PDF-бланк ответов** с уникальным QR-кодом (sheet token)
   - Случайно выбирается вариант (от 1 до N)
   - PDF сохраняется в MinIO
   - Бланк выдаётся участнику (печать)
   - Создаётся запись Attempt в статусе `PRINTED`

#### Этап 6: Выполнение работы (Участник)

Участник заполняет бланк ответов от руки, вписывает итоговый балл в специальное поле печатными цифрами.

#### Этап 7: Сканирование бланков (Сканировщик / Scanner)

1. Сканировщик фотографирует/сканирует заполненный бланк
2. Загружает файл (PNG, JPEG или PDF) через API
3. Файл сохраняется в MinIO
4. Создаётся запись Scan
5. Запускается Celery-задача `process_scan_ocr`:

   **a) Привязка к попытке:**
   - Из изображения извлекается QR-код (pyzbar)
   - Raw sheet_token хэшируется через HMAC-SHA256
   - По хэшу находится соответствующий Attempt
   - Scan связывается с Attempt

   **b) Распознавание балла:**
   - Область балла вырезается из изображения
   - Предобработка: серый → CLAHE → бинаризация
   - PaddleOCR извлекает текст
   - Парсинг числа из текста

   **c) Решение:**
   - Уверенность ≥ 70% → балл применяется автоматически (SCORED)
   - Уверенность < 70% → требует ручной проверки (SCANNED)

#### Этап 8: Ручная верификация (Сканировщик)

Для сканов с низкой уверенностью OCR:
1. Сканировщик открывает детали скана
2. Видит изображение скана и распознанный текст
3. Вводит корректный балл
4. Балл применяется к попытке

#### Этап 9: Публикация результатов (Администратор)

1. `IN_PROGRESS` → `CHECKING` — все работы собраны
2. `CHECKING` → `PUBLISHED` — результаты опубликованы

#### Этап 10: Просмотр результатов

Участники и общественность видят таблицу результатов: ранг, ФИО, школа, класс, балл.

---

## 11. API-эндпоинты

### Аутентификация (`/api/v1/auth`)

| Метод | Путь | Роль | Описание |
|---|---|---|---|
| POST | `/register` | Публичный | Регистрация участника (3/мин) |
| POST | `/login` | Публичный | Вход в систему (5/мин) |
| GET | `/me` | Любой авторизованный | Информация о текущем пользователе |

### Олимпиады (`/api/v1/competitions`)

| Метод | Путь | Роль | Описание |
|---|---|---|---|
| POST | `/` | Admin | Создать олимпиаду |
| GET | `/` | Публичный | Список олимпиад |
| GET | `/{id}` | Публичный | Детали олимпиады |
| PUT | `/{id}` | Admin | Обновить олимпиаду |
| DELETE | `/{id}` | Admin | Удалить олимпиаду |
| POST | `/{id}/open-registration` | Admin | Открыть регистрацию |
| POST | `/{id}/start` | Admin | Начать олимпиаду |
| POST | `/{id}/start-checking` | Admin | Начать проверку |
| POST | `/{id}/publish` | Admin | Опубликовать результаты |

### Регистрации (`/api/v1/registrations`)

| Метод | Путь | Роль | Описание |
|---|---|---|---|
| POST | `/` | Participant | Зарегистрироваться на олимпиаду |
| GET | `/` | Participant | Мои регистрации |
| GET | `/{id}` | Participant | Детали регистрации |
| POST | `/{id}/refresh-token` | Participant | Обновить QR допуска |

### Допуск (`/api/v1/admission`)

| Метод | Путь | Роль | Описание |
|---|---|---|---|
| POST | `/verify` | Admitter, Admin | Проверить QR допуска |
| POST | `/{id}/approve` | Admitter, Admin | Одобрить и выдать бланк |
| GET | `/sheets/{id}/download` | Admitter, Admin | Скачать PDF бланка |

### Сканы (`/api/v1/scans`)

| Метод | Путь | Роль | Описание |
|---|---|---|---|
| POST | `/upload` | Scanner, Admin | Загрузить скан (202 Accepted) |
| GET | `/` | Scanner, Admin | Список сканов |
| GET | `/{id}` | Scanner, Admin | Детали скана |
| GET | `/{id}/image` | Scanner, Admin | Изображение скана |
| POST | `/{id}/verify` | Scanner, Admin | Верифицировать балл |
| POST | `/attempts/{id}/apply-score` | Scanner, Admin | Применить балл вручную |

### Результаты (`/api/v1/results`)

| Метод | Путь | Роль | Описание |
|---|---|---|---|
| GET | `/{competition_id}` | Публичный | Результаты (403 если не опубликованы) |

### Администрирование (`/api/v1/admin`)

| Метод | Путь | Роль | Описание |
|---|---|---|---|
| GET | `/users` | Admin | Список пользователей |
| POST | `/users` | Admin | Создать пользователя |
| GET | `/audit-log` | Admin | Журнал аудита |

---

## 12. Фронтенд

### Маршрутизация (React Router 6)

```
Публичные маршруты:
  /login                 Страница входа
  /register              Регистрация участника
  /results/{id}          Публичные результаты

Участник (Participant):
  /dashboard             Олимпиады и регистрации
  /competitions          Список олимпиад
  /registrations/{id}/qr QR-код допуска

Допускающий (Admitter):
  /admission             Сканирование QR и допуск

Сканировщик (Scanner):
  /scans                 Список сканов + загрузка
  /scans/{id}            Детали скана + верификация

Администратор (Admin):
  /admin                 Панель управления
  /admin/users           Управление пользователями
  /admin/competitions    Управление олимпиадами
  /admin/audit-log       Журнал аудита
```

### Архитектура фронтенда

```
frontend/src/
├── api/client.ts         # Axios: baseURL=/api/v1, JWT-интерсептор
├── store/authStore.ts    # Zustand: токен, пользователь, login/logout
├── router/routes.tsx     # Маршрутизация с защитой по ролям
├── pages/                # Страницы по ролям
│   ├── auth/             # Вход и регистрация
│   ├── participant/      # Кабинет участника
│   ├── admitter/         # Интерфейс допуска
│   ├── scanner/          # Интерфейс сканирования
│   ├── admin/            # Панель администратора
│   └── public/           # Публичные результаты
├── components/           # Общие компоненты (QR-сканер, формы)
└── types/                # TypeScript-интерфейсы
```

Vite dev-сервер проксирует запросы `/api` на бэкенд (переменная `VITE_PROXY_TARGET`, по умолчанию `http://localhost:8000`).

---

## 13. Тестирование

### Стек тестирования

- **pytest** + **pytest-asyncio** — фреймворк
- **httpx** (AsyncClient) — HTTP-клиент для E2E тестов
- **SQLite in-memory** — изолированная БД для тестов

### Типы тестов

| Тип | Количество | БД | Описание |
|---|---|---|---|
| Unit | 54 | Нет | Доменная логика, сервисы |
| Integration | 40 | SQLite in-memory | Use Cases, репозитории |
| E2E | 30 | SQLite in-memory | Полные API-сценарии |

### Ключевые фикстуры

- `client` — httpx AsyncClient с ASGITransport
- `db_session` — асинхронная SQLAlchemy сессия (SQLite)
- `admin_user` / `participant_user` — предсозданные пользователи
- `make_auth_header(user_id, email, role)` — генерация JWT для тестов

### Запуск

```bash
cd backend/
poetry run pytest                         # Все 124 теста с покрытием
poetry run pytest tests/unit -v           # Только unit (54)
poetry run pytest tests/integration -v    # Только integration (40)
poetry run pytest tests/e2e -v            # Только E2E (30)
poetry run pytest --no-cov               # Без покрытия (быстрее)
```
