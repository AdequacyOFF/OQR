{
  "permissions": {
    "allow": [
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\domain\\\\repositories\\\\competition_repository.py\" << 'EOF'\n\"\"\"Competition repository interface.\"\"\"\n\nfrom abc import abstractmethod\nfrom typing import List\nfrom uuid import UUID\n\nfrom .base import BaseRepository\nfrom ..entities import Competition\nfrom ..value_objects import CompetitionStatus\n\n\nclass CompetitionRepository\\(BaseRepository[Competition]\\):\n    \"\"\"Repository interface for Competition entity.\"\"\"\n\n    @abstractmethod\n    async def get_by_status\\(self, status: CompetitionStatus, skip: int = 0, limit: int = 100\\) -> List[Competition]:\n        \"\"\"Get competitions by status.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_published\\(self, skip: int = 0, limit: int = 100\\) -> List[Competition]:\n        \"\"\"Get published competitions.\"\"\"\n        pass\nEOF)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\domain\\\\repositories\\\\registration_repository.py\" << 'EOF'\n\"\"\"Registration repository interface.\"\"\"\n\nfrom abc import abstractmethod\nfrom typing import List\nfrom uuid import UUID\n\nfrom .base import BaseRepository\nfrom ..entities import Registration\n\n\nclass RegistrationRepository\\(BaseRepository[Registration]\\):\n    \"\"\"Repository interface for Registration entity.\"\"\"\n\n    @abstractmethod\n    async def get_by_participant_and_competition\\(\n        self, participant_id: UUID, competition_id: UUID\n    \\) -> Registration | None:\n        \"\"\"Get registration by participant and competition.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_by_competition\\(\n        self, competition_id: UUID, skip: int = 0, limit: int = 1000\n    \\) -> List[Registration]:\n        \"\"\"Get all registrations for a competition.\"\"\"\n        pass\nEOF)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\domain\\\\repositories\\\\entry_token_repository.py\" << 'EOF'\n\"\"\"Entry token repository interface.\"\"\"\n\nfrom abc import abstractmethod\nfrom uuid import UUID\n\nfrom .base import BaseRepository\nfrom ..entities import EntryToken\n\n\nclass EntryTokenRepository\\(BaseRepository[EntryToken]\\):\n    \"\"\"Repository interface for EntryToken entity.\"\"\"\n\n    @abstractmethod\n    async def get_by_token_hash\\(self, token_hash: str\\) -> EntryToken | None:\n        \"\"\"Get entry token by token hash.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_by_registration\\(self, registration_id: UUID\\) -> EntryToken | None:\n        \"\"\"Get entry token by registration ID.\"\"\"\n        pass\nEOF)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\domain\\\\repositories\\\\attempt_repository.py\" << 'EOF'\n\"\"\"Attempt repository interface.\"\"\"\n\nfrom abc import abstractmethod\nfrom typing import List\nfrom uuid import UUID\n\nfrom .base import BaseRepository\nfrom ..entities import Attempt\n\n\nclass AttemptRepository\\(BaseRepository[Attempt]\\):\n    \"\"\"Repository interface for Attempt entity.\"\"\"\n\n    @abstractmethod\n    async def get_by_sheet_token_hash\\(self, sheet_token_hash: str\\) -> Attempt | None:\n        \"\"\"Get attempt by sheet token hash.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_by_registration\\(self, registration_id: UUID\\) -> Attempt | None:\n        \"\"\"Get attempt by registration ID.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_by_competition\\(self, competition_id: UUID, skip: int = 0, limit: int = 1000\\) -> List[Attempt]:\n        \"\"\"Get all attempts for a competition.\"\"\"\n        pass\nEOF)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\domain\\\\repositories\\\\scan_repository.py\" << 'EOF'\n\"\"\"Scan repository interface.\"\"\"\n\nfrom abc import abstractmethod\nfrom typing import List\nfrom uuid import UUID\n\nfrom .base import BaseRepository\nfrom ..entities import Scan\n\n\nclass ScanRepository\\(BaseRepository[Scan]\\):\n    \"\"\"Repository interface for Scan entity.\"\"\"\n\n    @abstractmethod\n    async def get_by_attempt\\(self, attempt_id: UUID\\) -> List[Scan]:\n        \"\"\"Get all scans for an attempt.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_unverified\\(self, skip: int = 0, limit: int = 100\\) -> List[Scan]:\n        \"\"\"Get scans that haven't been manually verified.\"\"\"\n        pass\nEOF)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\domain\\\\repositories\\\\audit_log_repository.py\" << 'EOF'\n\"\"\"Audit log repository interface.\"\"\"\n\nfrom abc import abstractmethod\nfrom typing import List\nfrom uuid import UUID\n\nfrom .base import BaseRepository\nfrom ..entities import AuditLog\n\n\nclass AuditLogRepository\\(BaseRepository[AuditLog]\\):\n    \"\"\"Repository interface for AuditLog entity.\"\"\"\n\n    @abstractmethod\n    async def get_by_entity\\(\n        self, entity_type: str, entity_id: UUID, skip: int = 0, limit: int = 100\n    \\) -> List[AuditLog]:\n        \"\"\"Get audit logs for a specific entity.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_by_user\\(self, user_id: UUID, skip: int = 0, limit: int = 100\\) -> List[AuditLog]:\n        \"\"\"Get audit logs for a specific user.\"\"\"\n        pass\nEOF)",
      "Bash(python -m py_compile:*)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\application\\\\use_cases\\\\registration\\\\__init__.py\" << 'EOF'\n\"\"\"Registration use cases.\"\"\"\n\nfrom .register_for_competition import RegisterForCompetitionUseCase\nfrom .get_entry_qr import GetEntryQRUseCase\nfrom .get_participant_registrations import GetParticipantRegistrationsUseCase\n\n__all__ = [\n    \"RegisterForCompetitionUseCase\",\n    \"GetEntryQRUseCase\",\n    \"GetParticipantRegistrationsUseCase\",\n]\nEOF)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\application\\\\use_cases\\\\registration\\\\register_for_competition.py\" << 'EOF'\n\"\"\"Register for competition use case.\"\"\"\n\nfrom uuid import UUID, uuid4\nfrom dataclasses import dataclass\n\nfrom ....domain.entities import Registration, EntryToken\nfrom ....domain.repositories import \\(\n    RegistrationRepository,\n    CompetitionRepository,\n    ParticipantRepository,\n    EntryTokenRepository\n\\)\nfrom ....domain.services import TokenService\nfrom ....config import settings\n\n\n@dataclass\nclass RegisterForCompetitionResult:\n    \"\"\"Result of registration.\"\"\"\n    registration_id: UUID\n    entry_token: str  # Raw token for QR code\n\n\nclass RegisterForCompetitionUseCase:\n    \"\"\"Use case for registering participant for competition.\"\"\"\n\n    def __init__\\(\n        self,\n        registration_repository: RegistrationRepository,\n        competition_repository: CompetitionRepository,\n        participant_repository: ParticipantRepository,\n        entry_token_repository: EntryTokenRepository,\n        token_service: TokenService\n    \\):\n        self.registration_repository = registration_repository\n        self.competition_repository = competition_repository\n        self.participant_repository = participant_repository\n        self.entry_token_repository = entry_token_repository\n        self.token_service = token_service\n\n    async def execute\\(\n        self,\n        participant_id: UUID,\n        competition_id: UUID\n    \\) -> RegisterForCompetitionResult:\n        \"\"\"Register participant for competition.\n\n        Args:\n            participant_id: Participant ID\n            competition_id: Competition ID\n\n        Returns:\n            Registration result with entry token\n\n        Raises:\n            ValueError: If validation fails\n        \"\"\"\n        # Check participant exists\n        participant = await self.participant_repository.get_by_id\\(participant_id\\)\n        if not participant:\n            raise ValueError\\(\"Participant not found\"\\)\n\n        # Check competition exists\n        competition = await self.competition_repository.get_by_id\\(competition_id\\)\n        if not competition:\n            raise ValueError\\(\"Competition not found\"\\)\n\n        # Check registration is open\n        if not competition.is_registration_open:\n            raise ValueError\\(\"Registration is not open for this competition\"\\)\n\n        # Check for duplicate registration\n        existing = await self.registration_repository.get_by_participant_and_competition\\(\n            participant_id, competition_id\n        \\)\n        if existing:\n            raise ValueError\\(\"Already registered for this competition\"\\)\n\n        # Create registration\n        registration = Registration\\(\n            id=uuid4\\(\\),\n            participant_id=participant_id,\n            competition_id=competition_id\n        \\)\n        registration = await self.registration_repository.create\\(registration\\)\n\n        # Generate entry token\n        token = self.token_service.generate_token\\(\n            size_bytes=settings.qr_token_size_bytes\n        \\)\n\n        # Create entry token entity\n        entry_token = EntryToken.create\\(\n            token_hash=token.hash,\n            registration_id=registration.id,\n            expire_hours=settings.entry_token_expire_hours\n        \\)\n        await self.entry_token_repository.create\\(entry_token\\)\n\n        return RegisterForCompetitionResult\\(\n            registration_id=registration.id,\n            entry_token=token.raw\n        \\)\nEOF)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\application\\\\use_cases\\\\registration\\\\get_participant_registrations.py\" << 'EOF'\n\"\"\"Get participant registrations use case.\"\"\"\n\nfrom uuid import UUID\nfrom typing import List\nfrom dataclasses import dataclass\n\nfrom ....domain.entities import Registration, Competition\nfrom ....domain.repositories import RegistrationRepository, CompetitionRepository\n\n\n@dataclass\nclass RegistrationWithCompetition:\n    \"\"\"Registration with competition details.\"\"\"\n    registration: Registration\n    competition: Competition\n\n\nclass GetParticipantRegistrationsUseCase:\n    \"\"\"Use case for getting participant's registrations.\"\"\"\n\n    def __init__\\(\n        self,\n        registration_repository: RegistrationRepository,\n        competition_repository: CompetitionRepository\n    \\):\n        self.registration_repository = registration_repository\n        self.competition_repository = competition_repository\n\n    async def execute\\(self, participant_id: UUID\\) -> List[RegistrationWithCompetition]:\n        \"\"\"Get all registrations for a participant.\n\n        Args:\n            participant_id: Participant ID\n\n        Returns:\n            List of registrations with competition info\n        \"\"\"\n        # This would need a custom repository method\n        # For now, we'll return empty list\n        # TODO: Implement get_by_participant in RegistrationRepository\n        return []\nEOF)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\presentation\\\\schemas\\\\registration_schemas.py\" << 'EOF'\n\"\"\"Registration-related Pydantic schemas.\"\"\"\n\nfrom pydantic import BaseModel\nfrom uuid import UUID\nfrom datetime import datetime\n\nfrom ...domain.value_objects import RegistrationStatus\n\n\nclass RegisterForCompetitionRequest\\(BaseModel\\):\n    \"\"\"Request to register for competition.\"\"\"\n    competition_id: UUID\n\n\nclass RegistrationResponse\\(BaseModel\\):\n    \"\"\"Response with registration info.\"\"\"\n    id: UUID\n    participant_id: UUID\n    competition_id: UUID\n    status: RegistrationStatus\n    created_at: datetime\n    entry_token: str | None = None  # Only included on creation\n\n    model_config = {\n        \"json_schema_extra\": {\n            \"examples\": [{\n                \"id\": \"123e4567-e89b-12d3-a456-426614174000\",\n                \"participant_id\": \"123e4567-e89b-12d3-a456-426614174001\",\n                \"competition_id\": \"123e4567-e89b-12d3-a456-426614174002\",\n                \"status\": \"pending\",\n                \"created_at\": \"2026-02-12T12:00:00\",\n                \"entry_token\": \"abcdef123456...\"\n            }]\n        }\n    }\n\n\nclass EntryQRResponse\\(BaseModel\\):\n    \"\"\"Response with entry QR code.\"\"\"\n    qr_code_base64: str\n    registration_id: UUID\n    expires_at: datetime\n    is_used: bool\n\n    model_config = {\n        \"json_schema_extra\": {\n            \"examples\": [{\n                \"qr_code_base64\": \"iVBORw0KGgoAAAANSUhEUgAA...\",\n                \"registration_id\": \"123e4567-e89b-12d3-a456-426614174000\",\n                \"expires_at\": \"2026-02-13T12:00:00\",\n                \"is_used\": False\n            }]\n        }\n    }\nEOF)",
      "Bash(\"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\backend\\\\src\\\\olimpqr\\\\presentation\\\\api\\\\v1\\\\registrations.py\" << 'EOF'\n\"\"\"Registration API endpoints.\"\"\"\n\nfrom typing import Annotated\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\nfrom ....infrastructure.database import get_db\nfrom ....infrastructure.repositories import \\(\n    RegistrationRepositoryImpl,\n    CompetitionRepositoryImpl,\n    ParticipantRepositoryImpl,\n    EntryTokenRepositoryImpl\n\\)\nfrom ....domain.services import TokenService, QRService\nfrom ....domain.value_objects import UserRole\nfrom ....domain.entities import User\nfrom ....application.use_cases.registration import \\(\n    RegisterForCompetitionUseCase,\n    GetEntryQRUseCase\n\\)\nfrom ...schemas.registration_schemas import \\(\n    RegisterForCompetitionRequest,\n    RegistrationResponse\n\\)\nfrom ...dependencies import require_role, get_current_active_user\nfrom ....config import settings\n\n\nrouter = APIRouter\\(\\)\n\n\n@router.post\\(\"/\", response_model=RegistrationResponse, status_code=status.HTTP_201_CREATED\\)\nasync def register_for_competition\\(\n    request: RegisterForCompetitionRequest,\n    current_user: Annotated[User, Depends\\(require_role\\(UserRole.PARTICIPANT\\)\\)],\n    db: Annotated[AsyncSession, Depends\\(get_db\\)]\n\\):\n    \"\"\"Register current participant for a competition.\n\n    Requires participant role.\n    Returns registration with entry_token \\(shown only once!\\).\n    \"\"\"\n    try:\n        # Get participant by user_id\n        participant_repo = ParticipantRepositoryImpl\\(db\\)\n        participant = await participant_repo.get_by_user_id\\(current_user.id\\)\n        if not participant:\n            raise HTTPException\\(\n                status_code=status.HTTP_404_NOT_FOUND,\n                detail=\"Participant profile not found\"\n            \\)\n\n        # Create repositories\n        registration_repo = RegistrationRepositoryImpl\\(db\\)\n        competition_repo = CompetitionRepositoryImpl\\(db\\)\n        entry_token_repo = EntryTokenRepositoryImpl\\(db\\)\n        token_service = TokenService\\(settings.hmac_secret_key\\)\n\n        # Create use case\n        use_case = RegisterForCompetitionUseCase\\(\n            registration_repo,\n            competition_repo,\n            participant_repo,\n            entry_token_repo,\n            token_service\n        \\)\n\n        # Execute\n        result = await use_case.execute\\(\n            participant_id=participant.id,\n            competition_id=request.competition_id\n        \\)\n\n        # Get registration to return full data\n        registration = await registration_repo.get_by_id\\(result.registration_id\\)\n\n        return RegistrationResponse\\(\n            id=registration.id,\n            participant_id=registration.participant_id,\n            competition_id=registration.competition_id,\n            status=registration.status,\n            created_at=registration.created_at,\n            entry_token=result.entry_token  # Only shown once!\n        \\)\n\n    except ValueError as e:\n        raise HTTPException\\(\n            status_code=status.HTTP_400_BAD_REQUEST,\n            detail=str\\(e\\)\n        \\)\nEOF)",
      "Bash(ls \"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\frontend\\\\src\"\" 2>nul || echo \"Directory does not exist \")",
      "Bash(ls \"D:\\\\Projects\\\\Kafedra\\\\OlimpQR\\\\frontend\"\" 2>nul || echo \"Frontend directory does not exist \")"
    ]
  }
}
